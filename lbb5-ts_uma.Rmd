---
title: "MLS - LBB5: Daily Exchange Rates per Euro"
author: "Taruma Sakti Megariansyah"
date: "`r Sys.Date()`"
output: 
 html_document: 
   toc: yes
   toc_float: yes
   highlight: zenburn
   theme: sandstone
   css: style.css
   code_folding: hide
   toc_depth: 5
   number_sections: yes
   df_print: paged
---

# SETUP

```{r, warning=FALSE, message=FALSE, class.output="scroll-100"}
library(tidyverse)
library(ggplot2)
library(forcats)
library(caret)
library(forecast)
library(TTR)
library(fpp)
library(xts)
library(lubridate)
library(padr)
options(scipen=999)
```

```{r}
R.version
```

LBB ini mendemonstrasikan pemodelan machine learning untuk data _time series_. 

Github
: Untuk file `.Rmd` atau `styles.css` bisa melihat github proyek ini di [taruma/mls-lbb-5](https://github.com/taruma/mls-lbb-5).

Notasi $\text{matematika}$
: Untuk ribuan akan menggunakan pemisah koma ($,$), sedangkan pemisah untuk angka dibelakang koma (desimal/mantissa) menggunakan titik ($.$).

Catatan
: Pada LBB ini untuk _piping_ akan menggunakan _native piping_ `|>` yang tersedia di `R 4.1+` untuk versi selain itu gunakan `%>%`. 

# Dataset {#sec-dataset}

Dataset yang digunakan adalah data [_Daily Exchange Rates per Euro 1999-2022_](https://www.kaggle.com/datasets/lsind18/euro-exchange-daily-rates-19992020) yang diperoleh dari Kaggle (Data diunduh pada hari Senin, 28 November 2022). Dataset ini berisikan _Exchange Rate_ (Nilai tukar) Euro/EUR (â‚¬) terhadap mata uang negara lain setiap harinya sejak tahun 1999. Berikut 6 baris pertama dataset.

```{r}
exchange <- read.csv("data/euro-daily-hist_1999_2022.csv")
exchange |> head()
```

Sebagai catatan, dataset diurutkan dari yang terbaru ke yang terlama. Sehingga, baris pertama merupakan data paling terbaru (2022) meski di halaman dataset dimulai dari 1999. Berikut 6 baris terakhir dataset `exchange`.

```{r}
exchange |> tail()
```

Berikut struktur dataset menggunakan `str()`.

```{r, class.output="scroll-100"}
str(exchange)
```

Dari struktur diatas diketahui terdapat kolom/negara yang berupa `character`, yang seharusnya berupa angka/numeric. Oleh karena itu, dataset `exchange` harus diolah kembali sebelum dilakukan pemodelan. Sebagai catatan, dataset `exchange` memiliki $6,177$ baris/observasi dan $41$ kolom/variabel. Proses tersebut dilanjutkan ke **R1 - Pemrosesan Data**.

# R1 - Pra-pemrosesan Data

Informasi struktur diatas menandakan banyak sekali yang harus diolah sebelum siap digunakan. Perubahan nama kolom dan tipe kolom merupakan hal yang cukup terlihat jelas dari kilasan dataset `exchange`. Sebelum memulai pra-pemrosesan data semua dataset yang digunakan pada tahap ini disimpan dalam objek `exchange_r1`. 

```{r}
exchange_r1 <- exchange
exchange_r1 |> head()
```

## Menamai Kolom

Nama kolom di `exchange` bisa berbeda ketika pembacaan dataset menggunakan `read_csv()`, tapi untuk dataset ini digunakan `read.csv()`. Nama kolom disimpan dalam variabel `name_columns`. 

```{r}
name_columns <- colnames(exchange_r1)
name_columns
```

Strategi dalam membuat nama baru adalah seluruh nama kolom berhuruf kecil semua dengan pemisahnya menggunakan titik. Jadi karakter seperti `X.` dihilangkan, dan `..` dihapus juga. Proses tersebut dilakukan menggunakan `str_replace()` dan `str_to_lower()`. Nama baru kolom disimpan dalam variabel `newname_columns`. Berikut nama baru kolom.

```{r}
newname_columns <- name_columns |> 
  str_replace("^X\\.", "") |> 
  str_replace("\\.+$", "") |> 
  str_to_lower()
newname_columns
```

Nama baru tersebut diterapkan ke dataset `exchange_r1` dan disimpan dalam objek baru bernama `exchange_r1_newname`.

```{r}
exchange_r1_newname <- exchange_r1 |> 
  setNames(newname_columns)

exchange_r1_newname |> head()
```
Dan berikut secara sekilas data `exchange_r1_newname`. 

```{r, class.output="scroll-100"}
exchange_r1_newname |> 
  glimpse()
```

Setelah nama kolom sudah dibersihkan, bisa dilanjutkan untuk mengubah tipe data setiap kolomnya. 

## Mengubah Tipe Data Kolom

Melihat informasi sekilas mengenai dataset `exchange_r1_newname`. Terdapat dua jenis data yang berbeda di dataset. Kolom pertama yaitu `period.unit` berupa tanggal dengan format `YYYY-MM-DD`. Sedangkan kolom lainnya, merupakan kolom numerik. 

### Kolom Waktu

Kolom yang merupakan waktu yaitu `period.unit`. Berikut sekilas data pada kolom `periode.unit`.

```{r}
set.seed(41608481)
exchange_r1_newname$period.unit |> sample(size=10)
```

Setelah mengetahui format `YYYY-MM-DD`, kolom tersebut bisa dikonversi menggunakan _library_ `lubridate` dengan fungsi `ymd()`. Hasil perubahan tersebut disimpan dalam bentuk objek baru bernama `exchange_r1_date`. Berikut beberapa baris pertamanya.

```{r}
exchange_r1_date <- exchange_r1_newname |> 
  mutate(period.unit = ymd(period.unit))
exchange_r1_date |> head()
```

Untuk memudahkan membaca, dataset diurutkan berdasarkan tanggal.

```{r}
exchange_r1_date <- exchange_r1_date |> 
  arrange(period.unit)
exchange_r1_date |> head()
```

Kita lihat _range_ waktu yang digunakan di `exchange_r1_date` dengan `summary()` pada kolom `period.unit`.  

```{r}
summary(exchange_r1_date$period.unit)
```

Setelah mengetahui tanggal dimulainya dan berakhirnya dataset. Akan dicek apakah ada tanggal yang tidak terekam di dataset. Digunakan `seq.Date()` untuk membuat _range_ dari 4 Januari 1999 hingga 15 November 2022. 

```{r}
date_start <- exchange_r1_date$period.unit |> min()
date_end <- exchange_r1_date$period.unit |> max()
date_range <- seq.Date(date_start, date_end, by = "day")
date_log_exist <- date_range %in% exchange_r1_date$period.unit
any(!date_log_exist)
```

Ternyata dari koding diatas diketahui bahwa terdapat tanggal yang hilang. Berikut tanggal dimana observasi tidak tersedia. 

```{r}
date_missing <- date_range[!date_log_exist]
date_range_wday <- date_range |> wday(label=TRUE, abbr = FALSE) |> summary()
date_missing_wday <- date_missing |> wday(label=TRUE, abbr = FALSE) |> summary() 
data.frame(date_range_wday, date_missing_wday) |> 
  mutate(missing_date_percent = date_missing_wday / date_range_wday * 100)
```

Diketahui bahwa data pada hari Sabtu dan Minggu tidak direkam sama sekali. Sedangkan terdapat juga di hari lain yang hilang dalam dataset. Perlu diingat, hilangnya data ini fokus pada tanggal yang tidak tersedia pada dataset original dan bukan kehilangan data pada kolom lainnya. 

Tanggal yang hilang pada `exchange_r1_date` dilengkapi menggunakan fungsi `pad()`. Berikut prosesnya dan pemeriksaannya setelah menggunakan fungsi `pad()` dan disimpan dalam objek baru bernama `exchange_r1_date_complete`.

```{r}
exchange_r1_date_complete <- exchange_r1_date |> 
  pad(interval = "day")

all(date_range %in% exchange_r1_date_complete$period.unit)
```

Dari nilai `TRUE` diatas, menandakan bahwa setiap tanggal pada _range_ 4 Januari 1999 hingga 15 November 2022 sudah terdapat baris/observasinya di objek `exchange_r1_date_complete`. Dengan kata lain, tidak ada tanggal yang hilang dalam objek tersebut. Berikut 8 baris pertama dataset.

```{r}
exchange_r1_date_complete |> head(8)
```

Untuk sementara _padding_ yang dilakukan diisi dengan nilai `NA`, yang nanti akan diproses lebih lanjut sebelum masuk eksplorasi data. Dan berikut informasi mengenai perubahan/penambahan baris setelah _padding_.

```{r}
data.frame(
  info = c("baris/observasi", "kolom/variabel"),
  nrow.date.original = exchange_r1 |> dim(),
  nrow.date.complete = exchange_r1_date_complete |> dim()
) |> column_to_rownames("info") |> 
  mutate(
    diff = nrow.date.complete - nrow.date.original,
    diff_percent = diff / nrow.date.complete * 100
  )
```

Dari informasi diatas diketahui bahwa banyaknya baris yang ditambahkan menggunakan _padding_ sebanyak $2,540$ baris atau sekitar $29\%$ dari total baris lengkapnya data. Untuk catatan banyaknya baris tersebut disimpan dalam variabel `total_padding`.

```{r}
total_padding <- nrow(exchange_r1_date_complete) - nrow(exchange_r1)
```


### Kolom Numerik

Selain kolom `period.unit`, kolom lainnya merupakan kolom numerik. Akan tetapi pada saat pembacaan `read.csv()` terjadi _coercing_ sehingga kolom tersebut berubah menjadi tipe data `character`. Sebelum memaksakan kolom tersebut menjadi numerik, diinginkan untuk mengidentifikasi apa yang terjadi dengan dataset tersebut sehingga membuat kolom tersebut menjadi `character`. 

Berikut jumlah jenis kolom masing-masing dari dataset `exchange_r1_date_complete`. 

```{r}
exchange_r1_date_complete |> 
  sapply(class) |> table()
```

Diketahui ada $37$ kolom yang bertipe `character` dan hanya $3$ yang numeric. Berikut informasi mengenai tipe setiap kolomnya. 

```{r}
column_type_exchange <- exchange_r1_date_complete |> 
  sapply(class) |> as.data.frame() |> set_names("column.type") |> 
  arrange(column.type)
column_type_exchange
```

Berikut kolom yang berupa numerik dan tanggal.

```{r}
column_type_exchange |> 
  filter(column.type %in% c("Date", "numeric"))
```

Jadi untuk `iceland.krona`, `romanian.leu`, dan `turkish.lira` sudah berupa numerik. 

#### Investigasi _coercion_

Pada bagian ini, diinginkan untuk memperoleh informasi kenapa terjadinya _coercion_ sehingga mengubah kolom tersebut menjadi tipe `character`. Untuk evaluasi tersebut akan menggunakan objek `exchange_r1_coercion` yang merupakan `exchange_r1_date_complete` dengan nama baris `period.unit`.

```{r}
exchange_r1_coercion <- exchange_r1_date_complete |>
  column_to_rownames("period.unit")
  
exchange_r1_coercion |> head()
```

Berikut daftar karakter yang bukan merupakan angka di dataset `exchange_r1_coercion`.  

```{r}
list_of_character <- exchange_r1_coercion |>
  select_if(is_character) |> 
  lapply(
    function (.) {
      is_digits <- str_detect(., "[:digit:]")
      is_na <- is.na(.)
      not_digits <- !(is_digits | is_na)
      row_not_digits <- .[not_digits]
      row_unique <- row_not_digits |> unique()
    }
  )

list_of_character |> unlist() |> unique()
```
Dari informasi diatas, karakter `"-"` merupakan penyebab kenapa kolom tersebut diubah menjadi `character`. karakter `""` (karakter kosong) muncul dikarenakan terdapat karakter dikolom tersebut dan terjadi _coercion_ sehingga memaksakan nilai yang kosong menjadi `""` (`character`)). Berikut dikolom mana saja karakter tersebut muncul.

```{r}
list_of_character |> 
  lapply(\(.) {paste("[", ., "]", sep = "", collapse = ",")}) |> 
  as.data.frame() |> t() |> as.data.frame() |> setNames("not.digit")
```

Dari informasi diatas, bisa diketahui juga bahwa kolom yang tidak memiliki `[]` (`$not.digit` hanya memiliki nilai `[-]`) diartikan tidak memiliki data yang kosong saat pembacaan. Untuk menghitung tepat jumlah baris yang diisi dengan `"-"`, elemen yang `""` akan dibuat `NA`.

```{r}
exchange_r1_coercion[exchange_r1_coercion == ""] <- NA
exchange_r1_coercion |> head()
```

Dengan kode diatas maka nilai yang `""` akan diubah menjadi `NA`, sehingga karakter yang diidentifikasi penyebab _coercion_ itu adalah `"-"`. Selanjutnya ingin mengidentifikasi tanggal mana saja yang terjadi tidak ada data (menggunakan indikator `"-"`).

```{r}

func_logi_dash <- function(.) {
  is_dash <- (. == "-")
  logi_dash <- is_dash |> 
    apply(1, any, na.rm = TRUE)
}

logi_dash <- exchange_r1_coercion |> func_logi_dash()
exchange_r1_coercion |> filter(logi_dash)
```

Dari informasi diatas, terdapat $63$ baris yang memiliki nilai `"-"` (tidak ada). Berikut hari dimana data tersebut tidak tersedia.

```{r}
exchange_r1_coercion |> filter(logi_dash) |> 
  rownames() |> wday(label = TRUE, abbr = FALSE) |> table()
```

Perlu diingat bahwa hari Sabtu dan Minggu, memang tidak direkam dan tersedia di dataset original sama sekali, sehingga tidak muncul sama sekali di dataset. Langkah berikutnya adalah mengubah nilai `"-"` menjadi `NA`. Berikut hasil perubahannya di objek `exchange_r1_coercion`. 

```{r}
exchange_r1_coercion[exchange_r1_coercion == "-"] <- NA
exchange_r1_coercion |> subset(logi_dash)
```

Untuk memastikan tidak ada karakter yang bukan angka, diperiksa kembali objek `exchange_r1_coercion`. Berikut hasil pemeriksaannya.

```{r}
exchange_r1_coercion |> 
  lapply(str_detect, pattern = "[:digit:]") |> 
  lapply(all, na.rm = TRUE) |> 
  unlist() |> all()
```

Dari hasil diatas, sudah dipastikan bahwa pada `exchange_r1_coercion` seluruh isiannya merupakan angka. Oleh karena itu, semua kolom karakter tersebut bisa diubah menjadi numeric dengan fungsi `as.numeric()`. Hasil perubahan tersebut disimpan dalam objek baru bernama `exchange_r1_numeric`. 

```{r, class.output="scroll-100"}
exchange_r1_numeric <- exchange_r1_coercion |> 
  mutate_if(is_character, as.numeric)
exchange_r1_numeric |> str()
```

Proses berikutnya adalah mengevaluasi data yang hilang (`NA`). 

## Data yang hilang

Sebelum mengisi data yang hilang, sebaiknya di eksplorasi terlebih dahulu mengenai informasi hilangnya data. Dataset yang digunakan adalah objek `exchange_r1_numeric` yang telah mengubah seluruh tipe kolom menjadi numerik. 

### Eksplorasi data yang hilang 

```{r}
missing_val <- exchange_r1_numeric |> is.na() |> colSums()
missing_val |> as.data.frame() |> 
  mutate(missing_percentage = missing_val / nrow(exchange_r1_numeric) * 100) |> 
  arrange(missing_percentage |> desc())
```

Dari informasi diatas nilai `NA` yang dibangkitkan dari _padding_ terhitung juga. Karena jumlah _padding_ yang dilakukan sudah diketahui pada tahap sebelumnya yaitu sebanyak $2,540$ baris (disimpan dalam variabel `total_padding`). Maka baris yang hilang dikurangi jumalh tersebut untuk memastikan banyaknya data yang hilang ketika tidak dilakukan _padding_ atau hilangnya data aktualnya. 

```{r}
missing_val_actual <- missing_val |> as.data.frame() |> 
  mutate(
    missing_val_actual = missing_val - total_padding,
    percentage_missing_actual = missing_val_actual / (nrow(exchange_r1_numeric) - total_padding) * 100
  ) |> 
  arrange(percentage_missing_actual |> desc())
missing_val_actual
```

Berikut visualisasinya agar memudahkan melihat perbandingannya.

```{r, fig.align='center', fig.height=6, fig.cap="Banyaknya Baris yang Hilang (Aktual)"}
missing_val_actual |> 
  rownames_to_column("currency") |> 
  ggplot(aes(x = fct_reorder(currency, missing_val_actual), y = missing_val_actual)) +
  geom_col(aes(fill = percentage_missing_actual)) +
  scale_fill_gradient(low = "green", high = "black") +
  theme_bw() +
  labs(
    title = "Hilangnya Data (Aktual)",
    x = "Mata Uang",
    y = "Jumlah Baris yang Hilang",
    fill = "Persen Hilang"
  ) +
  coord_flip()
```

Dari informasi diatas diambil kesimpulan untuk mengambil beberapa kolom saja yang memiliki kelengkapan data yang lebih baik. Dari eksplorasi diatas, diambil keputusan untuk mengambil kolom yang memiliki data yang hilang aktual kurang dari $100$. Kolom terpilih disimpan dalam variabel `selected_country`.

```{r}
selected_country <- missing_val_actual |> 
  filter(missing_val_actual <= 100) |> 
  rownames()
selected_country
```

Kolom-kolom yang terpilih disimpan dalam bentuk objek baru bernama `exchange_r1_selected`. Berikut kilasan dataset. 

```{r, class.output="scroll-100"}
exchange_r1_selected <- exchange_r1_numeric |> 
  select(all_of(selected_country))
exchange_r1_selected |> glimpse()
```

Dari dataset tersebut bisa dilanjutkan ke pengisian data yang hilang. 

### Pengisian data yang hilang

Dataset `exchange_r1_selected` diperiksa nilai data yang hilang. Dari narasi diatas diketahui, hari Sabtu dan Minggu, memang tidak tersedia datanya. Sehingga, observasi tersebut harus diisi jika menginginkan dataset yang kontinyu dengan interval waktu dalam bentuk harian. Berikut baris yang hilang dan disimpan dalam bentuk  

```{r}
exchange_r1_missing <- exchange_r1_selected |> 
  filter(exchange_r1_selected |> is.na() |> apply(1, all)) |> 
  rownames_to_column("period.unit") |> 
  mutate(
    period.unit = ymd(period.unit)
  )
exchange_r1_missing
```






# R2 - Eksplorasi Data

```{r, eval=FALSE}
exchange_r1_selected |> 
  # boxplot()
  mutate_if(is.numeric, function(.) {
    minvec <- min(., na.rm = TRUE)
    maxvec <- max(., na.rm = TRUE)
    normalize <- (. - minvec) / (maxvec - minvec)
  }) |> 
  rownames_to_column("period.unit") |>
  mutate(period.unit = ymd(period.unit)) |>
  pivot_longer(cols = all_of(selected_country), names_to = "currency", values_to = "rate") |>
  arrange(currency) |>
  ggplot(aes(x = period.unit, y = rate, color = currency)) +
  geom_line()
```

# R3 - Pemodelan

# R4 - Evaluasi

# Kesimpulan

## Saran

Berikut saran yang bisa diberikan:

- Pada tahapan mengubah tipe data kolom, bisa dievaluasi setiap kolomnya atau kolom tertentu (tergantung kebutuhan bisnisnya). Sehinggga fokus eksplorasi data sudah ditentukan sejak awal yaitu sebelum masuk ke pra-pemrosesan data. 
- Di investigasi akhir _coercion_, dinyatakan bahwa "seluruh isiannya merupakan angka". Hal tersebut bisa keliru jika terdapat isian yang merupakan angka tapi tidak _valid_. Semisal, nilai "1.23121312.3" akan dideteksi `TRUE` karena memiliki komponen `:digit:`, meski jika dilakukan `as.numeric()` akan muncul peringatan dan menghasilkan nilai `NA`. Hal tersebut dikarenakan penggunaan `str_detect()` dengan `pattern = "[:digit:]"`. 
- Konsistensi penamaan dengan `class` objek. Dalam lembar kerja, objek `missing_val` merupakan `list`, sedangkan `missing_val_actual` merupakan `data.frame`. Untuk konsistensi dan memudahkan _troubleshooting_, sebaiknya dilakukan penamaan dan konsistensi tipe objeknya. 
